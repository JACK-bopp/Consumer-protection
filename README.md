# 个人消费 & 订阅守护 MCP 方案

## 背景与目标
- **目标用户**：大学生、上班族，频繁通过支付宝、微信、银行卡消费，办有多个线上会员。
- **核心痛点**：
  - 缺乏整体视图，无法快速回答“钱花到哪里了”。
  - 自动续费被遗忘，导致重复或无效支出。
- **产品定位**：做“记录 + 分析 + 提醒”，不触碰高风险投资决策，强调安全、透明、可控。

## 关键能力（MCP 工具）
| 工具 | 作用 | 说明 |
| --- | --- | --- |
| `spending.import_transactions` | 同步支付宝 MCP 账单或本地 CSV/Excel 导入 | 首选支付宝支付 MCP Server；支持用户上传银行/运营商账单做补充。 |
| `spending.categorize` | 消费自动分类（餐饮/购物/学习/交通等） | 结合商户名、支付宝交易标签、金额与时间特征。 |
| `subscriptions.detect` | 识别高频固定扣款 | 通过“商户 + 周期 + 金额”三元组，检测会员/订阅。 |
| `subscriptions.set_guard` | 到期/扣款前提醒 | 提前 N 天推送；可生成一键关闭操作指引。 |
| `budget.analyze_month(user_ref, month)` | 月度消费报告与异常提示 | 输出分布、趋势、异常大额/异常频次提示。 |

## 核心用户体验
1. **一键同步**：用户授权后从支付宝 MCP 拉取近 3/6/12 个月账单，或上传 CSV/Excel 进行补充。
2. **自动分类与订阅识别**：后台调用 `spending.categorize` 与 `subscriptions.detect`，生成“消费雷达图 + 订阅列表”。
3. **智能提醒**：
   - 订阅到期/扣款前提醒；可配置提前天数。
   - 异常消费（大额、在非活跃商户的重复扣款）提示。
4. **按需导出与对账**：提供 PDF/Excel 月报，含分类占比、趋势、订阅一览。

## 数据流设计（简版）
1. **数据源**：支付宝 MCP `import_transactions` → 交易流水（含商户、金额、时间、订单状态、退款标记）。
2. **预处理**：去重/合并退款；解析商户标签；金额标准化（人民币）。
3. **分类**：`spending.categorize` 输出类别 + 置信度；低置信度条目请求用户确认并持续学习。
4. **订阅检测**：`subscriptions.detect` 基于固定周期 + 金额；生成候选订阅、下次扣款日、可取消指引。
5. **报告生成**：`budget.analyze_month` 生成月度分布、异常消费摘要；前端展示雷达图、时间线、订阅列表。

## 关键场景与策略
- **“我每个月钱去哪了？”**：展示 Top 类别、Top 商户、环比变化；突出异常大额条目。
- **“怎么又自动扣了？”**：订阅列表标注“最近扣款 / 下次扣款 / 使用频率”；对低使用频率的订阅给出关闭建议。
- **多渠道账单**：若用户上传银行/运营商 CSV，统一进账本；标记来源，避免与支付宝重复计算。

## 风险与合规边界
- 仅做消费记录、分析、提醒；不提供投资/借贷推荐。
- 尊重用户隐私：最小化存储、可随时删除数据；明示数据用途（分类与提醒）。
- 安全操作：所有支付行为需显式用户确认；避免自动代扣或高权限操作。

## MVP 里程碑
1. **v0**：支付宝 MCP 账单同步 + 分类 + 订阅检测，提供月报与提醒（短信/站内）。
2. **v1**：支持 CSV/Excel 导入、导出；订阅一键关闭指引。
3. **v2**：多渠道账单（银行/运营商）、更细粒度异常检测（地理位置/时段异常）。

## 评估指标
- 月活导入率（授权/上传成功率）
- 分类准确率与用户确认覆盖率
- 订阅识别准确率、提醒点击率
- 取消/降级订阅的转化（为用户节省的金额）

---

## 本地 UX 原型与真实 API 连通
本仓库附带一个零依赖（仅 Node.js）的本地静态站点和代理，方便验证真实 API 密钥与基础网络连通性。

### 文件结构
```
public/                # 静态资源与 UX 模块入口
  index.html
  main.js
  styles.css
src/
  api/client.js        # 前端调用 /api/status 的封装
  components/          # 预留组件目录
scripts/
  build-config.js      # 根据 .env 生成 public/runtime-config.json
server.js              # 静态资源 + /api/status 代理
.env.example           # 运行所需密钥与端点占位
```

### 环境配置
1. 复制 `.env.example` 为 `.env` 并填写真实服务参数：
   ```bash
   cp .env.example .env
   # 编辑后补充
   # API_BASE_URL=https://<your-real-api-host>
   # API_KEY=<your-secret-key>
   # PORT=5173  # 可选
   ```
2. 生成运行时配置（仅暴露非敏感的 API 地址）：
   ```bash
   npm run build-config
   ```
3. 启动本地服务器：
   ```bash
   npm start
   ```
   访问 `http://localhost:5173`，界面会调用 `/api/status` 代理远程 API，显示密钥配置与连通结果。

> 真实 API 连接需要有效的 `API_KEY`。请确认已经从支付/账单服务平台获取并填入 `.env`；密钥不会暴露到前端，仅在 Node 侧使用。

### 下一步 UX 开发指引
- 在 `src/components` 下扩展交易、订阅、预算可视化组件，调用对应后端路由。
- 在 `server.js` 补充更多代理（如 `/api/transactions`、`/api/subscriptions`），并在代理中注入密钥与鉴权头。
- 若需要 HTTPS 或 Webhook，可在服务器层添加签名校验与日志记录模块。
